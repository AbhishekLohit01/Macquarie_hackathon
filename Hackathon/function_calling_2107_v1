{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "99811470",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\hp\\anaconda3\\lib\\site-packages\\numpy\\_distributor_init.py:30: UserWarning: loaded more than 1 DLL from .libs:\n",
      "C:\\Users\\hp\\anaconda3\\lib\\site-packages\\numpy\\.libs\\libopenblas.WCDJNK7YVMPZQ2ME2ZZHJJRJ3JIKNDB7.gfortran-win_amd64.dll\n",
      "C:\\Users\\hp\\anaconda3\\lib\\site-packages\\numpy\\.libs\\libopenblas64__v0.3.21-gcc_10_3_0.dll\n",
      "  warnings.warn(\"loaded more than 1 DLL from .libs:\"\n"
     ]
    }
   ],
   "source": [
    "from dotenv import dotenv_values\n",
    "import openai\n",
    "from openai import OpenAI\n",
    "import numpy as np\n",
    "import os\n",
    "import sqlite3"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "39483b1d",
   "metadata": {},
   "outputs": [],
   "source": [
    "api_key = dotenv_values(\"../api_data.env\")\n",
    "openai.api_key = api_key['OPEN_AI_KEY']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "fb798c02",
   "metadata": {},
   "outputs": [],
   "source": [
    "client = OpenAI(api_key=os.environ.get(\"OPENAI_API_KEY\", openai.api_key))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "a29fa1c3",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Opened database successfully\n"
     ]
    }
   ],
   "source": [
    "import sqlite3\n",
    "\n",
    "conn = sqlite3.connect(\"alerting_db_ver6\")\n",
    "print(\"Opened database successfully\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "abaa0182",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_table_names(conn):\n",
    "    \"\"\"Return a list of table names.\"\"\"\n",
    "    table_names = []\n",
    "    tables = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table';\")\n",
    "    for table in tables.fetchall():\n",
    "        table_names.append(table[0])\n",
    "    return table_names\n",
    "\n",
    "\n",
    "def get_column_names(conn, table_name):\n",
    "    \"\"\"Return a list of column names.\"\"\"\n",
    "    column_names = []\n",
    "    columns = conn.execute(f\"PRAGMA table_info('{table_name}');\").fetchall()\n",
    "    for col in columns:\n",
    "        column_names.append(col[1])\n",
    "    return column_names\n",
    "\n",
    "\n",
    "def get_database_info(conn):\n",
    "    \"\"\"Return a list of dicts containing the table name and columns for each table in the database.\"\"\"\n",
    "    table_dicts = []\n",
    "    for table_name in get_table_names(conn):\n",
    "        columns_names = get_column_names(conn, table_name)\n",
    "        table_dicts.append({\"table_name\": table_name, \"column_names\": columns_names})\n",
    "    return table_dicts"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "ff7bf605",
   "metadata": {},
   "outputs": [],
   "source": [
    "database_schema_dict = get_database_info(conn)\n",
    "database_schema_string = \"\\n\".join(\n",
    "    [\n",
    "        f\"Table: {table['table_name']}\\nColumns: {', '.join(table['column_names'])}\"\n",
    "        for table in database_schema_dict\n",
    "    ]\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "8f078349",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'Table: alerts_table\\nColumns: alert_id, alert_date, trader_id, model_name\\nTable: deals_table\\nColumns: alert_id, deal_number, price, volume'"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "database_schema_string"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "6fc60c06",
   "metadata": {},
   "outputs": [],
   "source": [
    "tools = [\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"ask_database\",\n",
    "            \"description\": \"Use this function to answer user questions about Alerts and Deals in trading data. Input should be a fully formed SQL query.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"query\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": f\"\"\"\n",
    "                                SQL query extracting info to answer the user's question.\n",
    "                                SQL should be written using this database schema:\n",
    "                                {database_schema_string}\n",
    "                                The query should be returned in plain text, not in JSON.\n",
    "                                \"\"\",\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"query\"],\n",
    "            },\n",
    "        }\n",
    "    }\n",
    "]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "0996618a",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "def ask_database_function(conn, query):\n",
    "    \"\"\"Function to query SQLite database with a provided SQL query.\"\"\"\n",
    "    try:\n",
    "        results = pd.read_sql_query(query, conn)\n",
    "        #results = str(conn.execute(query).fetchall())\n",
    "    except Exception as e:\n",
    "        results = f\"query failed with error: {e}\"\n",
    "    return results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "ecba2d03",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>alert_id</th>\n",
       "      <th>alert_date</th>\n",
       "      <th>trader_id</th>\n",
       "      <th>model_name</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Alert_0</td>\n",
       "      <td>2024-05-07</td>\n",
       "      <td>trader_22</td>\n",
       "      <td>model_17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Alert_1</td>\n",
       "      <td>2024-06-05</td>\n",
       "      <td>trader_22</td>\n",
       "      <td>model_11</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Alert_2</td>\n",
       "      <td>2023-07-17</td>\n",
       "      <td>trader_3</td>\n",
       "      <td>model_19</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Alert_3</td>\n",
       "      <td>2024-01-11</td>\n",
       "      <td>trader_38</td>\n",
       "      <td>model_17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Alert_4</td>\n",
       "      <td>2023-12-13</td>\n",
       "      <td>trader_29</td>\n",
       "      <td>model_8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4995</th>\n",
       "      <td>Alert_4995</td>\n",
       "      <td>2023-10-21</td>\n",
       "      <td>trader_20</td>\n",
       "      <td>model_1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4996</th>\n",
       "      <td>Alert_4996</td>\n",
       "      <td>2024-06-06</td>\n",
       "      <td>trader_27</td>\n",
       "      <td>model_15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4997</th>\n",
       "      <td>Alert_4997</td>\n",
       "      <td>2023-09-12</td>\n",
       "      <td>trader_6</td>\n",
       "      <td>model_18</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4998</th>\n",
       "      <td>Alert_4998</td>\n",
       "      <td>2024-02-27</td>\n",
       "      <td>trader_28</td>\n",
       "      <td>model_3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4999</th>\n",
       "      <td>Alert_4999</td>\n",
       "      <td>2023-09-30</td>\n",
       "      <td>trader_21</td>\n",
       "      <td>model_14</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5000 rows × 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "        alert_id  alert_date  trader_id model_name\n",
       "0        Alert_0  2024-05-07  trader_22   model_17\n",
       "1        Alert_1  2024-06-05  trader_22   model_11\n",
       "2        Alert_2  2023-07-17   trader_3   model_19\n",
       "3        Alert_3  2024-01-11  trader_38   model_17\n",
       "4        Alert_4  2023-12-13  trader_29    model_8\n",
       "...          ...         ...        ...        ...\n",
       "4995  Alert_4995  2023-10-21  trader_20    model_1\n",
       "4996  Alert_4996  2024-06-06  trader_27   model_15\n",
       "4997  Alert_4997  2023-09-12   trader_6   model_18\n",
       "4998  Alert_4998  2024-02-27  trader_28    model_3\n",
       "4999  Alert_4999  2023-09-30  trader_21   model_14\n",
       "\n",
       "[5000 rows x 4 columns]"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "query =  \"SELECT * FROM alerts_table\"\n",
    "#df = pd.read_sql_query(query, conn)\n",
    "a = ask_database_function(conn,query)\n",
    "a"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "02c71a85",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>alert_id</th>\n",
       "      <th>deal_number</th>\n",
       "      <th>price</th>\n",
       "      <th>volume</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Alert_0</td>\n",
       "      <td>deal_714</td>\n",
       "      <td>31</td>\n",
       "      <td>9791</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Alert_1</td>\n",
       "      <td>deal_653</td>\n",
       "      <td>48</td>\n",
       "      <td>402</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Alert_2</td>\n",
       "      <td>deal_176</td>\n",
       "      <td>18</td>\n",
       "      <td>4383</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Alert_3</td>\n",
       "      <td>deal_997</td>\n",
       "      <td>17</td>\n",
       "      <td>4451</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Alert_4</td>\n",
       "      <td>deal_242</td>\n",
       "      <td>11</td>\n",
       "      <td>6322</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4995</th>\n",
       "      <td>Alert_4995</td>\n",
       "      <td>deal_186</td>\n",
       "      <td>85</td>\n",
       "      <td>5819</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4996</th>\n",
       "      <td>Alert_4996</td>\n",
       "      <td>deal_41</td>\n",
       "      <td>98</td>\n",
       "      <td>6628</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4997</th>\n",
       "      <td>Alert_4997</td>\n",
       "      <td>deal_30</td>\n",
       "      <td>24</td>\n",
       "      <td>932</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4998</th>\n",
       "      <td>Alert_4998</td>\n",
       "      <td>deal_57</td>\n",
       "      <td>86</td>\n",
       "      <td>8116</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4999</th>\n",
       "      <td>Alert_4999</td>\n",
       "      <td>deal_111</td>\n",
       "      <td>99</td>\n",
       "      <td>2393</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5000 rows × 4 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "        alert_id deal_number  price  volume\n",
       "0        Alert_0    deal_714     31    9791\n",
       "1        Alert_1    deal_653     48     402\n",
       "2        Alert_2    deal_176     18    4383\n",
       "3        Alert_3    deal_997     17    4451\n",
       "4        Alert_4    deal_242     11    6322\n",
       "...          ...         ...    ...     ...\n",
       "4995  Alert_4995    deal_186     85    5819\n",
       "4996  Alert_4996     deal_41     98    6628\n",
       "4997  Alert_4997     deal_30     24     932\n",
       "4998  Alert_4998     deal_57     86    8116\n",
       "4999  Alert_4999    deal_111     99    2393\n",
       "\n",
       "[5000 rows x 4 columns]"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "query =  \"SELECT * FROM deals_table\"\n",
    "#df = pd.read_sql_query(query, conn)\n",
    "a = ask_database_function(conn,query)\n",
    "a"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "6a03ec40",
   "metadata": {},
   "outputs": [],
   "source": [
    "# query =  \"SELECT * from alerts_table where trader_id = \"trader_10\"''\n",
    "# #df = pd.read_sql_query(query, conn)\n",
    "# a = ask_database_function(conn,query)\n",
    "# a"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "38cfa093",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "e8e5ce7e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'query failed with error: Execution failed on sql \\'SELECT year,\\n           SUM(CASE WHEN year = 2023 THEN alert_count ELSE 0 END) -\\n           SUM(CASE WHEN year = 2024 THEN alert_count ELSE 0 END) AS alert_count_difference\\n           FROM (\\n                SELECT COUNT(alert_id) AS alert_count,\\n                       EXTRACT(YEAR FROM alert_date) AS year\\n                FROM alerts_table\\n                WHERE trader_id = \\'trader_10\\'\\n                      AND EXTRACT(YEAR FROM alert_date) IN (2023, 2024)\\n                GROUP BY year\\n            )\\n            GROUP BY year;\\n\\': near \"FROM\": syntax error'"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "query =  \"\"\"SELECT year,\n",
    "           SUM(CASE WHEN year = 2023 THEN alert_count ELSE 0 END) -\n",
    "           SUM(CASE WHEN year = 2024 THEN alert_count ELSE 0 END) AS alert_count_difference\n",
    "           FROM (\n",
    "                SELECT COUNT(alert_id) AS alert_count,\n",
    "                       EXTRACT(YEAR FROM alert_date) AS year\n",
    "                FROM alerts_table\n",
    "                WHERE trader_id = 'trader_10'\n",
    "                      AND EXTRACT(YEAR FROM alert_date) IN (2023, 2024)\n",
    "                GROUP BY year\n",
    "            )\n",
    "            GROUP BY year;\n",
    "\"\"\"\n",
    "#df = pd.read_sql_query(query, conn)\n",
    "a = ask_database_function(conn,query)\n",
    "a"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "af00a6d6",
   "metadata": {},
   "outputs": [],
   "source": [
    "GPT_MODEL = \"gpt-3.5-turbo\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eab7aedc",
   "metadata": {},
   "outputs": [],
   "source": [
    "assistant_system_prompt = \"\"\"You are a chatbot. Your role is to answer user questions politely and competently.\n",
    "You should follow these instructions to solve the case:\n",
    "- Understand their question and get the relevant answer.\n",
    "- Make use of the ongoing chat conversation to anwer question and do not just rely on tool.\n",
    "- Answer only if you are fully confident of the answer, otherwise say that can you please frame the sentence again.\n",
    "\"\"\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c8dc443a",
   "metadata": {},
   "outputs": [],
   "source": [
    "#!/usr/bin/env python\n",
    "import PySimpleGUI as sg\n",
    "\n",
    "'''\n",
    "A simple send/response chat window.  Add call to your send-routine and print the response\n",
    "If async responses can come in, then will need to use a different design that uses PySimpleGUI async design pattern\n",
    "\n",
    "Copyright 2023 PySimpleSoft, Inc. and/or its licensors. All rights reserved.\n",
    "\n",
    "Redistribution, modification, or any other use of PySimpleGUI or any portion thereof is subject to the terms of the PySimpleGUI License Agreement available at https://eula.pysimplegui.com.\n",
    "\n",
    "You may not redistribute, modify or otherwise use PySimpleGUI or its contents except pursuant to the PySimpleGUI License Agreement.\n",
    "\n",
    "'''\n",
    "\n",
    "sg.theme('GreenTan') # give our window a spiffy set of colors\n",
    "\n",
    "layout = [[sg.Text('Your output will go here', size=(40, 1))],\n",
    "          [sg.Output(size=(110, 20), font=('Helvetica 10'))],\n",
    "          [sg.Multiline(size=(70, 5), enter_submits=True, key='-QUERY-', do_not_clear=False),\n",
    "           sg.Button('SEND', button_color=(sg.YELLOWS[0], sg.BLUES[0]), bind_return_key=True),\n",
    "           sg.Button('EXIT', button_color=(sg.YELLOWS[0], sg.GREENS[0]))]]\n",
    "\n",
    "window = sg.Window('Chat window', layout, font=('Helvetica', ' 13'), default_button_element_size=(8,2), use_default_focus=False)\n",
    "\n",
    "#conversation_messages = []\n",
    "conversation_messages = [\n",
    "    {\n",
    "                \"role\": \"system\",\n",
    "                \"content\": assistant_system_prompt\n",
    "    }\n",
    "]\n",
    "try:\n",
    "    while True:     # The Event Loop\n",
    "        event, values = window.read()\n",
    "        if event in (sg.WIN_CLOSED, 'EXIT'):            # quit if exit button or X\n",
    "            break\n",
    "        if event == 'SEND':\n",
    "            user_question = values['-QUERY-'].rstrip()\n",
    "            conversation_messages.append ({\n",
    "            \"role\":\"user\", \n",
    "            \"content\": user_question\n",
    "            })\n",
    "            print(user_question)\n",
    "            #conversation_messages.append(messages)\n",
    "\n",
    "            response = client.chat.completions.create(\n",
    "                model=GPT_MODEL, \n",
    "                messages=conversation_messages, \n",
    "                tools= tools, \n",
    "                tool_choice=\"auto\"\n",
    "            )\n",
    "\n",
    "            # Append the message to messages list\n",
    "            response_message = response.choices[0].message \n",
    "\n",
    "\n",
    "            # Step 2: determine if the response from the model includes a tool call.   \n",
    "            tool_calls = response_message.tool_calls\n",
    "            if tool_calls:\n",
    "                # If true the model will return the name of the tool / function to call and the argument(s)  \n",
    "                tool_call_id = tool_calls[0].id\n",
    "                tool_function_name = tool_calls[0].function.name\n",
    "                tool_query_string = eval(tool_calls[0].function.arguments)['query']\n",
    "\n",
    "                print(\"tool_query_string:  \",tool_query_string)\n",
    "#                 conversation_messages.append({\n",
    "#                     \"role\":\"assistant\", \n",
    "#                     \"content\": tool_query_string\n",
    "#                     })\n",
    "\n",
    "                #Step 3: Call the function and retrieve results. Append the results to the messages list.      \n",
    "                if tool_function_name == 'ask_database':\n",
    "                    results = ask_database(conn, tool_query_string)\n",
    "                    print(\"results\",type(results))\n",
    "                    conversation_messages.append({\n",
    "                        \"role\":\"tool\", \n",
    "                        \"tool_call_id\":tool_call_id, \n",
    "                        \"name\": tool_function_name, \n",
    "                        \"content\":results\n",
    "                    })\n",
    "                    print(\"conversation_messages:\",conversation_messages)\n",
    "                    # Step 4: Invoke the chat completions API with the function response appended to the messages list\n",
    "                    # Note that messages with role 'tool' must be a response to a preceding message with 'tool_calls'\n",
    "                    model_response_with_function_call = client.chat.completions.create(\n",
    "                        model= GPT_MODEL,\n",
    "                        messages=conversation_messages,\n",
    "                    )  # get a new response from the model where it can see the function response\n",
    "                    print(model_response_with_function_call.choices[0].message.content)\n",
    "                else: \n",
    "                    print(f\"Error: function {tool_function_name} does not exist\")\n",
    "            else:\n",
    "                # Model did not identify a function to call, result can be returned to the user\n",
    "                conversation_messages.append({\n",
    "                    \"role\":\"assistant\", \n",
    "                    \"content\": response_message.content\n",
    "                    })\n",
    "                print(response_message.content)\n",
    "except Exception as e:\n",
    "    print(\"Exception occured :\",e)\n",
    "    \n",
    "#window.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4f1cf087",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Step #1: Prompt with content that may result in function call. In this case the model can identify the information requested by the user is potentially available in the database schema passed to the model in Tools description. \n",
    "messages = [{\n",
    "    \"role\":\"user\", \n",
    "    \"content\": user_question\n",
    "}]\n",
    "\n",
    "response = client.chat.completions.create(\n",
    "    model='gpt-3.5-turbo', \n",
    "    messages=messages, \n",
    "    tools= tools, \n",
    "    tool_choice=\"auto\"\n",
    ")\n",
    "\n",
    "# Append the message to messages list\n",
    "response_message = response.choices[0].message \n",
    "messages.append(response_message)\n",
    "\n",
    "print(response_message)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "32109065",
   "metadata": {},
   "outputs": [],
   "source": [
    "tool_calls = response_message.tool_calls\n",
    "tool_calls"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "91e5eeaf",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Step 2: determine if the response from the model includes a tool call.   \n",
    "tool_calls = response_message.tool_calls\n",
    "if tool_calls:\n",
    "    # If true the model will return the name of the tool / function to call and the argument(s)  \n",
    "    tool_call_id = tool_calls[0].id\n",
    "    tool_function_name = tool_calls[0].function.name\n",
    "    tool_query_string = eval(tool_calls[0].function.arguments)['query']\n",
    "    \n",
    "    # Step 3: Call the function and retrieve results. Append the results to the messages list.      \n",
    "    if tool_function_name == 'ask_database':\n",
    "        results = ask_database(conn, tool_query_string)\n",
    "        \n",
    "        messages.append({\n",
    "            \"role\":\"tool\", \n",
    "            \"tool_call_id\":tool_call_id, \n",
    "            \"name\": tool_function_name, \n",
    "            \"content\":results,\n",
    "            \"arguments\":\n",
    "        })\n",
    "        \n",
    "        # Step 4: Invoke the chat completions API with the function response appended to the messages list\n",
    "        # Note that messages with role 'tool' must be a response to a preceding message with 'tool_calls'\n",
    "        model_response_with_function_call = client.chat.completions.create(\n",
    "            model=\"gpt-4o\",\n",
    "            messages=messages,\n",
    "        )  # get a new response from the model where it can see the function response\n",
    "        print(model_response_with_function_call.choices[0].message.content)\n",
    "    else: \n",
    "        print(f\"Error: function {tool_function_name} does not exist\")\n",
    "else: \n",
    "    # Model did not identify a function to call, result can be returned to the user \n",
    "    print(response_message.content) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7706dce0",
   "metadata": {},
   "outputs": [],
   "source": [
    "#pip install PySimpleGUI"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3142019a",
   "metadata": {},
   "outputs": [],
   "source": [
    "#!/usr/bin/env python\n",
    "import PySimpleGUI as sg\n",
    "\n",
    "'''\n",
    "A simple send/response chat window.  Add call to your send-routine and print the response\n",
    "If async responses can come in, then will need to use a different design that uses PySimpleGUI async design pattern\n",
    "\n",
    "Copyright 2023 PySimpleSoft, Inc. and/or its licensors. All rights reserved.\n",
    "\n",
    "Redistribution, modification, or any other use of PySimpleGUI or any portion thereof is subject to the terms of the PySimpleGUI License Agreement available at https://eula.pysimplegui.com.\n",
    "\n",
    "You may not redistribute, modify or otherwise use PySimpleGUI or its contents except pursuant to the PySimpleGUI License Agreement.\n",
    "\n",
    "'''\n",
    "\n",
    "sg.theme('GreenTan') # give our window a spiffy set of colors\n",
    "\n",
    "layout = [[sg.Text('Your output will go here', size=(40, 1))],\n",
    "          [sg.Output(size=(110, 20), font=('Helvetica 10'))],\n",
    "          [sg.Multiline(size=(70, 5), enter_submits=True, key='-QUERY-', do_not_clear=False),\n",
    "           sg.Button('SEND', button_color=(sg.YELLOWS[0], sg.BLUES[0]), bind_return_key=True),\n",
    "           sg.Button('EXIT', button_color=(sg.YELLOWS[0], sg.GREENS[0]))]]\n",
    "\n",
    "window = sg.Window('Chat window', layout, font=('Helvetica', ' 13'), default_button_element_size=(8,2), use_default_focus=False)\n",
    "\n",
    "while True:     # The Event Loop\n",
    "    event, values = window.read()\n",
    "    if event in (sg.WIN_CLOSED, 'EXIT'):            # quit if exit button or X\n",
    "        break\n",
    "    if event == 'SEND':\n",
    "        query = values['-QUERY-'].rstrip()\n",
    "        # EXECUTE YOUR COMMAND HERE\n",
    "        print('The command you entered was {}'.format(query), flush=True)\n",
    "\n",
    "window.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "278573fe",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eccce502",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d42ef122",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "3e1c5664",
   "metadata": {},
   "source": [
    "### Create a dummy database"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 48,
   "id": "70b520ae",
   "metadata": {},
   "outputs": [],
   "source": [
    "conn = sqlite3.connect(\"alerting_db_ver6\")\n",
    "c = conn.cursor()\n",
    "\n",
    "c.execute(\n",
    "    \"\"\"\n",
    "    CREATE TABLE IF NOT EXISTS alerts_table\n",
    "    ([alert_id] TEXT PRIMARY KEY, [alert_date] TEXT, [trader_id] TEXT  , [model_name] TEXT )\n",
    "    \"\"\"\n",
    ")\n",
    "\n",
    "c.execute(\n",
    "    \"\"\"\n",
    "    CREATE TABLE IF NOT EXISTS deals_table\n",
    "    ([alert_id] INTEGER, [deal_number] TEXT,[price] INTEGER,[volume] INTEGER)\n",
    "    \"\"\"\n",
    ")\n",
    "\n",
    "conn.commit()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 50,
   "id": "d00e9bca",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Insert data into Alert table\n",
    "for row in alert_df.itertuples(index=False):\n",
    "    c.execute('''\n",
    "    INSERT INTO alerts_table (alert_id, alert_date, trader_id, model_name)\n",
    "    VALUES (?, ?, ?, ?)\n",
    "    ''', (row.alert_id, row.alert_date, row.trader_id, row.model_name))\n",
    "\n",
    "# Insert data into Deal table\n",
    "for row in deal_df.itertuples(index=False):\n",
    "    c.execute('''\n",
    "    INSERT INTO deals_table (alert_id, deal_number, price, volume)\n",
    "    VALUES (?, ?, ?, ?)\n",
    "    ''', (row.alert_id, row.deal_number, row.price, row.volume))\n",
    "\n",
    "# Commit the transaction\n",
    "conn.commit()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5eefaab3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# import sqlite3\n",
    "# import pandas as pd\n",
    "\n",
    "# conn = sqlite3.connect(\"alerting_db\")\n",
    "# c = conn.cursor()\n",
    "\n",
    "# c.execute(\n",
    "#     \"\"\"\n",
    "#     SELECT\n",
    "#     *\n",
    "#     FROM deals_table where deal_number = 'deal_0'\n",
    "#     \"\"\"\n",
    "# )\n",
    "\n",
    "# df = pd.DataFrame(c.fetchall(), columns=['alert_id', 'deal_date', 'deal_number', 'price', 'volume'])\n",
    "\n",
    "# print(df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "id": "fd656f20",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "from datetime import datetime, timedelta\n",
    "import random\n",
    "import uuid\n",
    "\n",
    "# Generate random dates\n",
    "def random_date(start, end):\n",
    "    return start + timedelta(\n",
    "        seconds=random.randint(0, int((end - start).total_seconds())),\n",
    "    )\n",
    "\n",
    "# Parameters\n",
    "num_rows = 5000\n",
    "start_date = datetime(2023, 7, 1)\n",
    "end_date = datetime(2024, 7, 1)\n",
    "\n",
    "# Generate data for Alert table\n",
    "alert_data = {\n",
    "    \"alert_id\": [\"Alert_\"+str(r) for r in range(num_rows)],\n",
    "    \"alert_date\": [random_date(start_date, end_date).strftime(\"%Y-%m-%d\") for _ in range(num_rows)],\n",
    "    \"trader_id\": [f\"trader_{random.randint(1, 50)}\" for i in range(num_rows)],\n",
    "    #\"deal_number\": [f\"deal_{random.randint(1, 1000)}\" for i in range(num_rows)],\n",
    "    \"model_name\": [f\"model_{random.randint(1, 20)}\" for _ in range(num_rows)]\n",
    "}\n",
    "\n",
    "# Generate data for Deal table\n",
    "deal_data = {\n",
    "    \"alert_id\": [\"Alert_\"+str(r) for r in range(num_rows)],\n",
    "    \"deal_number\": [f\"deal_{random.randint(1, 1000)}\" for _ in range(num_rows)],\n",
    "    \"price\": [random.randint(1, 100) for _ in range(num_rows)],\n",
    "    \"volume\": [random.randint(100, 10000) for _ in range(num_rows)]\n",
    "}\n",
    "\n",
    "# Create DataFrames\n",
    "alert_df = pd.DataFrame(alert_data)\n",
    "deal_df = pd.DataFrame(deal_data)\n",
    "\n",
    "# Merge DataFrames on alert_id\n",
    "merged_df = pd.merge(alert_df, deal_df, on=\"alert_id\")\n",
    "\n",
    "# Show the DataFrame\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 51,
   "id": "ecc4abb0",
   "metadata": {},
   "outputs": [],
   "source": [
    "alert_df.to_csv('input_data/function_calling/alert_df.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "id": "c731c3b3",
   "metadata": {},
   "outputs": [],
   "source": [
    "alert_df.to_csv('input_data/function_calling/deal_df.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6e2a4dd8",
   "metadata": {},
   "outputs": [],
   "source": [
    "merged_df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "96cd1ea6",
   "metadata": {},
   "outputs": [],
   "source": [
    "merged_df = "
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
